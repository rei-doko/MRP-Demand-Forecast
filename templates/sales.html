{% extends "base.html" %}
{% block content %}
<h2>Sales Data</h2>

{% if message %}
<div class="alert alert-danger mt-2" id="msg-box">{{ message }}</div>
{% endif %}

<!-- Select / Open Product Folder -->
<form method="GET" class="mb-4">
    <div class="mb-2">
        <label>Select Product Folder:</label>
        <select name="product_id" id="product-select" class="form-select" required>
            <option value="">-- Select Product --</option>
            {% for product in products %}
                <option value="{{ product['product_id'] }}" {% if selected_product and selected_product['product_id'] == product['product_id'] %}selected{% endif %}>
                    Product ID: {{ product['product_id'] }} - {{ product['product_name'] }}
                </option>
            {% endfor %}
        </select>
    </div>
    <button type="submit" class="btn btn-primary">Open Folder</button>
</form>

<hr>

{% if selected_product %}
<div class="sales-folder mb-3">
    <h4>Product ID: {{ selected_product['product_id'] }} - {{ selected_product['product_name'] }}</h4>

    <!-- Update Week and Sales -->
    <form method="POST" class="mb-3" action="{{ url_for('sales') }}">
        <input type="hidden" name="product_id" value="{{ selected_product['product_id'] }}">
        <div class="mb-2">
            <label>Week</label>
            <input type="number" name="week" min="1" class="form-control" required>
        </div>
        <div class="mb-2">
            <label>Amount</label>
            <input type="number" name="amount" min="0" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-success">Update</button>
    </form>

    <!-- Delete Weeks -->
    <form method="POST" action="{{ url_for('delete_sales') }}" class="mb-3">
        <input type="hidden" name="product_id" value="{{ selected_product['product_id'] }}">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th style="width:1%"></th>
                    <th>Week</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for sale in weekly_sales %}
                <tr>
                    <td><input type="checkbox" name="delete_weeks[]" value="{{ sale['week'] }}"></td>
                    <td>{{ sale['week'] }}</td>
                    <td>{{ sale['amount'] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
    </form>

    <!-- Forecast Output -->
    <div id="forecast-output" class="p-3 border rounded bg-light">
        Loading forecast...
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const forecastDiv = document.getElementById('forecast-output');
    const productId = ("{{ selected_product['product_id'] }}"); // already works

    fetch(`{{ url_for('sales_forecast') }}?product_id=${productId}`)
        .then(response => response.json())
        .then(data => {
            if(data.error){
                forecastDiv.innerHTML = data.error;
            } else {
                // Round next week prediction to whole number
                const smapeValue = data.sMAPE_percent !== null ? data.sMAPE_percent.toFixed(2) + "%" : "N/A";
                const nextWeek = data.next_week_prediction !== null ? Math.round(data.next_week_prediction) : "N/A";

                forecastDiv.innerHTML = `
                    <h5>Forecast (Weighted Moving Average)</h5>
                    <ul>
                        <li>Forecast Error (sMAPE): ${smapeValue}</li>
                        <li>Next week prediction (Rounded): ${nextWeek}</li>
                    </ul>
                `;
            }
        })
        .catch(err => {
            forecastDiv.innerHTML = "Error fetching forecast";
            console.error(err);
        });
});
</script>
{% endif %}

{% endblock %}